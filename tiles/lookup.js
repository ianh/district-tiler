var tree = [274799857,245080017,297779343,1834179383,1819959015,1822756452,307559649,202658446,181304939,253719358,1859076909,1808871718,1842778534,1839426056,314716168,184967332,230752507,172337393,203572561,1796585320,264946719,261998442,259652951,1794205240,288631829,288013169,1855825672,1826246698,1845366431,1849554799,323154511,180551766,188297214,215861130,1788354319,170132429,1869677097,1877360030,222099863,1788912170,1806158647,1798960771,1795534825,1837106063,1841217570,1883635627,1868387891,292184235,287162047,283987263,294878602,283091366,1830608184,289165950,280216631,1820127348,303700784,305993891,1850810934,1845895708,1853893033,1856633765,325303032,174244201,1815072583,1811730842,1820461305,1815281551,1794780909,243217346,1804852201,166825012,1877585027,1841393395,1891286426,196703381,191841633,1851883751,1849224511,1786827411,249756953,250572504,248457018,257782803,260115960,267685915,1805332659,254660967,253818730,268822310,268649890,250288971,248060172,273706749,1876928905,1791589849,1780719502,279882283,291899673,279069773,1813511333,1816952496,1813898816,1831996198,1829338251,292221581,291274299,283938268,293411134,1860874955,1863192329,1816125870,302303611,1833490834,1834645298,303720679,1842726666,303912738,1852885505,1843075304,311325017,312133300,1857206176,315727770,1862852716,1865278054,327951443,172787819,1830098079,1813760649,1823214260,1808102841,1813564149,195417754,197028325,205517343,204534646,224724747,1818744953,241255787,1781718672,243549150,1814775443,75588033,1863892092,1843091655,1890308044,174312968,1845148324,1880306628,175277639,1868856168,1853172325,1889391104,1883481844,219070008,1855189230,223749264,1867106881,1784135659,251828228,245977969,251659095,248057574,1802322865,1807825148,1809539037,1790727378,1793613990,1805789524,1813701087,1790747403,268891724,268076760,269377503,249835073,1827223737,1849419550,1844143666,1828334750,1830041045,1843566983,1851600976,1867350108,1876807596,1895695037,248743674,271168713,1861645270,268693055,267303872,1784380663,287829043,1769383294,1787948164,1802877823,1802965524,1801587280,1803534034,1812808312,1816664167,285724560,285806107,292546984,291354916,295530385,1818156930,278218723,281057356,285792244,1838066627,290029271,293989303,1836691545,293328373,279974562,1848198037,1848946722,1851410213,275403354,1862843267,290511283,287316639,1808698004,301675502,300487690,303188314,299016953,300881294,1832338912,305663763,301021268,1842169162,1842239098,306783512,300766806,306052029,300017444,301821447,1831980521,308250393,309298967,312385307,310145973,313756007,313143240,1864869991,1852803405,316351038,319429286,320663254,1862374358,1873492633,1880772047,334705613,68974901,1832465948,1825964441,177347189,184386313,183809788,182828018,1828194197,1806260581,187230085,186262891,1814199559,1808998718,1811782847,193467717,200209411,1810179094,205970945,1816242657,206268264,1793143733,227019614,222011798,219877536,238363815,1786170937,1767663857,1786440840,238526058,1791282556,241600452,240525284,43037039,1956968627,1856566680,1879671725,1840317721,1852689941,1881631411,1894588707,1836437993,175746959,175827010,1848016384,1874633638,173917029,1894220407,176415462,1861116070,191937214,1849975521,1861155930,188332278,187783176,196219389,195069665,208748712,1846038713,205663026,1876872438,1846502963,224839253,232490382,226703987,1777772027,250859730,247774822,252500438,1791262871,1791745548,1793032481,1789817710,1805665346,1802809360,253106592,252102768,247688684,1811828039,249301853,250498461,255400823,1796157977,263208763,261489205,259641584,1811251870,1805111337,262646758,1788991090,266662412,1790286947,1791597485,1802108427,272362672,1817039338,1810490443,1822156511,1826589961,258596028,258203373,250433667,250557878,257547042,257514591,267980293,266917214,271911432,271558878,266737154,1850786948,270662760,271625375,248876189,1869555406,255729901,257726372,1893565049,1900405882,1888353923,253493920,267157133,1862931129,1860334100,1866781770,264818207,271969498,1882431963,1885194080,1777670755,290335559,284345145,291671294,1765808926,1777359090,293963983,1791458405,276351110,278224446,283174560,283191442,290082210,289238660,293961045,294821175,277512236,1816320659,279869988,282099918,1811518289,286324677,1816424036,1819320216,1813319049,1814200866,1819686392,292240028,1809723529,1810061454,296953659,295918647,1827260340,280076403,278056072,1837693239,1825532618,1826364989,284591947,286196887,1825065844,1825397249,1826307484,1824148255,290745913,289492174,1834726324,1837324653,1848755357,1849968059,285451525,287341943,290842696,290241192,295855081,294480522,1860080494,275812482,275000888,1866480263,287457800,293555839,1867863523,1864630546,1806308470,299553657,300195014,302603373,1823814458,1823721424,1822526129,305506174,1830185654,300973978,299355754,1837105246,304614682,305932435,1835549251,1835387701,299751571,1843524743,304680270,305605617,306563908,307011924,1843191961,1843686466,299672463,301967160,1847034107,1846844138,298752013,303713651,1858877521,1864008229,1829705823,308154666,1844489428,308498194,1846380568,310511284,1848256067,313131903,308795412,1850792311,1850580456,1851796086,311455941,1854454916,311718212,311897354,1849784425,1853600408,1853398974,317040162,318537615,320451282,1866781627,1870677371,1860777161,324677345,1869110597,1879202470,1871949773,1885018273,1885821730,337091969,];
function lookupDistrict(lng, lat, callback) {
    function encodeCoordinate(axis, c) {
        d = axis ? 180 : 360;
        return ((c / d + 0.5) * ((1<<30) - 1)) | 0;
    }
    function readCoordinate(buffer, i, last) {
        if ((buffer[i] & 0xc0) === 0x80) {
            // Absolute coordinate.
            return ((buffer[i] & 0x3f) << 24) + (buffer[i + 1] << 16) + (buffer[i + 2] << 8) + buffer[i + 3];
        } else if ((buffer[i] & 0x80) === 0x00) {
            // Relative coordinate.
            d = (buffer[i] << 8) + buffer[i + 1];
            if (d & 0x4000)
                d = -((~d + 1) & 0x7fff);
            return last + d;
        } else {
            throw "Invalid byte in tile data.";
        }
    }
    function orientation(x0, y0, x1, y1, px, py) {
        return (x1 - x0) * (py - y0) - (px - x0) * (y1 - y0);
    }
    var px = encodeCoordinate(0, lng);
    var py = encodeCoordinate(1, lat);
    var index = 0;
    var tilenum = 0;
    while (index < tree.length) {
        tilenum *= 2;
        var cutoff = tree[index];
        var axis = 0;
        if (cutoff & 0x40000000) {
            axis = 1;
            cutoff &= 0x3fffffff;
        }
        var lower = false;
        if (axis === 0)
            lower = (px < cutoff);
        else
            lower = (py < cutoff);
        if (lower) {
            index = 2 * index + 1;
        } else {
            tilenum += 1;
            index = 2 * index + 2;
        }
    }
    var request = new XMLHttpRequest();
    request.open("GET", "tiles/tile-" + ("0000" + tilenum).slice(-4), true);
    request.responseType = "arraybuffer";
    request.onreadystatechange = function () {
        if (request.readyState !== 4)
            return;
        if (request.status !== 200 && window.location.protocol !== "file:") {
            callback("failed");
            return;
        }
        var buffer = new Uint8Array(request.response);
        var state = -1;
        var district = -1;
        var lastx = -1;
        var lasty = -1;
        var winding = 0;
        for (var i = 0; i + 2 <= buffer.length; i += 2) {
            if (buffer[i] === 0xff) {
                if (buffer[i + 1] === 0xff) {
                    // New part in this district.
                } else {
                    // Entirely new district.
                    if (winding > 0)
                        break;
                    winding = 0;
                    state = buffer[i + 2];
                    district = buffer[i + 3];
                    i += 2;
                }
                lastx = -1;
                lasty = -1;
                continue;
            }
            var x = readCoordinate(buffer, i, lastx);
            if ((buffer[i] & 0xc0) === 0x80)
                i += 2;
            i += 2;
            var y = readCoordinate(buffer, i, lasty);
            if ((buffer[i] & 0xc0) === 0x80)
                i += 2;

            if (lastx != -1 && lasty != -1) {
                // Check if this edge crossed the query point vertically.  We count these crossings to determine whether the query point is inside the current district.
                if (lasty <= py) {
                    if (y > py) {
                        if (orientation(lastx, lasty, x, y, px, py) > 0)
                            winding--;
                    }
                } else {
                    if (y <= py) {
                        if (orientation(lastx, lasty, x, y, px, py) < 0)
                            winding++;
                    }
                }
            }
            lastx = x;
            lasty = y;
        }
        if (winding > 0)
            callback("found", state, district);
        else
            callback("notfound");
    };
    request.timeout = 10000;
    request.send();
}
